
more.annot <- getBM(filters=filters, values=values, attributes=attributes, mart=ensmart)

#ditch any that don't have a symbol
more.annot <- more.annot[more.annot[,"mgi_symbol"]!="",]

#and some have more than one symbol, but the same desc, so ditch them
more.annot <- more.annot[-1*(which(duplicated(more.annot[,c(1,3)]))),]

rownames(more.annot) <- more.annot[,"ensembl_gene_id"]

#add this extra data to the data.annot
data.annot <- data.frame(data.annot, more.annot[data.annot[,"feature"],])

#and add all of this to your original rd
rd<-as.data.frame(rd)
nms<-as.character(rd$names)
rownames(rd)<-nms
data.annot<-data.annot[nms,]   #sort annotation to same order as rd
rd<-cbind(rd, data.annot) 

colnames(rd)<-gsub( "values.","", colnames(rd))
colnames(rd)[17] <- "gene.strand"
colnames(rd)[19] <- "gene.start"
colnames(rd)[20] <- "gene.end"
colnames(rd)[21] <- "is.inside.gene"
colnames(rd)[22] <- "distance.to.gene"














library(IRanges)

#call like R --vanilla --args filename=\"thing\"
args<-commandArgs()
eval(parse(text=args[grep('filename', args)]))
load(filename)

library(ChIPpeakAnno)

#load mouse transcripts
data(TSS.mouse.NCBIM37)

#need to alter the names so they match ChIPpeakAnno
names(rd)<-gsub("chr","",names(rd))

data.annot <- annotatePeakInBatch(rd, AnnotationData=TSS.mouse.NCBIM37)


#and that only gives you the ensembl gene ID, so get extra info:
library(biomaRt)

ensmart <- useMart("ensembl", dataset="mmusculus_gene_ensembl")
                
filters <- c("ensembl_gene_id")
values<-unique(as.character(values(data.annot)[,"feature"]))
attributes <- c("ensembl_gene_id","mgi_symbol", "description")

more.annot <- getBM(filters=filters, values=values, attributes=attributes, mart=ensmart)

#ditch any that don't have a symbol
more.annot <- more.annot[more.annot[,"mgi_symbol"]!="",]

#and some have more than one symbol, but the same desc, so ditch them
more.annot <- more.annot[-1*(which(duplicated(more.annot[,c(1,3)]))),]

rownames(more.annot) <- more.annot[,"ensembl_gene_id"]

#and reset the values data.annot with the extra annotation
#and the original scores.
annot <- values(data.annot)
rd <- values(rd)
new.annot <- list()
for(i in 1:length(annot)){
 this.df <- annot[[i]]
 this.rd.df <- rd[[i]]
 these.ids <- this.df[,"feature"]
 this.df<-cbind(this.df,this.rd.df,DataFrame( more.annot[these.ids,2:3]))
 new.annot[[i]] <- DataFrame(this.df)
}


new.annot <- SplitDataFrameList(new.annot, compress=T)
names(new.annot) <- names(annot)

values(data.annot) <- new.annot


newfile<-sub("RangedData", "AnnoRangedData", filename)
save(data.annot, file=newfile)
